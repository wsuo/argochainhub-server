<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜WebSocketè¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 5px 0; border-radius: 3px; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        .log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ ç®¡ç†å‘˜WebSocketè¿æ¥æµ‹è¯•</h1>
        
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <div>
            <label for="token">ç®¡ç†å‘˜Token:</label>
            <input type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA">
        </div>
        
        <div>
            <button id="connectBtn" class="btn-primary" onclick="connect()">è¿æ¥WebSocket</button>
            <button id="disconnectBtn" class="btn-danger" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
            <button class="btn-success" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <h3>ğŸ“œ è¿æ¥æ—¥å¿—</h3>
        <div id="log" class="log"></div>
        
        <h3>ğŸ“¢ æµ‹è¯•æŒ‰é’®</h3>
        <div>
            <button class="btn-primary" onclick="testBroadcastNotification()">æµ‹è¯•å¹¿æ’­é€šçŸ¥</button>
            <button class="btn-primary" onclick="testPermissionNotification()">æµ‹è¯•æƒé™é€šçŸ¥</button>
            <button class="btn-primary" onclick="testSystemAlert()">æµ‹è¯•ç³»ç»Ÿå‘Šè­¦</button>
        </div>
    </div>

    <script>
        let socket = null;
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            if (type === 'error') logEntry.style.color = 'red';
            if (type === 'success') logEntry.style.color = 'green';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(connected) {
            if (connected) {
                statusElement.textContent = 'âœ… å·²è¿æ¥';
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'âŒ æœªè¿æ¥';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            const token = document.getElementById('token').value;
            if (!token) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç®¡ç†å‘˜Token');
                return;
            }

            log('æ­£åœ¨è¿æ¥WebSocketæœåŠ¡å™¨...');
            
            socket = new WebSocket('ws://localhost:3050/notifications?token=' + encodeURIComponent(token) + '&type=admin');
            
            socket.onopen = function(event) {
                log('WebSocketè¿æ¥å·²å»ºç«‹ï¼Œç®¡ç†å‘˜è®¤è¯æˆåŠŸ', 'success');
                updateStatus(true);
            };
            
            socket.onmessage = function(event) {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    log('æ”¶åˆ°éJSONæ¶ˆæ¯: ' + event.data);
                    return;
                }
                
                if (data.type === 'notification') {
                    log('ğŸ“¢ æ”¶åˆ°é€šçŸ¥: ' + JSON.stringify(data, null, 2), 'success');
                } else if (data.type === 'unread_count_update') {
                    log('ğŸ“Š æœªè¯»æ•°é‡æ›´æ–°: ' + data.count, 'info');
                } else {
                    log('æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data, null, 2));
                }
            };
            
            socket.onerror = function(error) {
                log('WebSocketé”™è¯¯: ' + error, 'error');
                updateStatus(false);
            };
            
            socket.onclose = function(event) {
                log('WebSocketè¿æ¥å·²å…³é—­ (ä»£ç : ' + event.code + ', åŸå› : ' + event.reason + ')');
                updateStatus(false);
            };
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        function clearLog() {
            logElement.innerHTML = '';
        }

        // æµ‹è¯•æŒ‰é’®åŠŸèƒ½
        function testBroadcastNotification() {
            fetch('/api/v1/admin/notifications/broadcast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + document.getElementById('token').value
                },
                body: JSON.stringify({
                    type: 'SYSTEM_MAINTENANCE',
                    title: 'æµ‹è¯•å¹¿æ’­é€šçŸ¥',
                    content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¹¿æ’­é€šçŸ¥æ¶ˆæ¯ã€‚',
                    priority: 'NORMAL',
                    category: 'SYSTEM'
                })
            }).then(response => response.json())
            .then(data => {
                log('å¹¿æ’­é€šçŸ¥å‘é€ç»“æœ: ' + JSON.stringify(data));
            }).catch(error => {
                log('å‘é€å¹¿æ’­é€šçŸ¥å¤±è´¥: ' + error, 'error');
            });
        }

        function testPermissionNotification() {
            fetch('/api/v1/admin/notifications/by-permission', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + document.getElementById('token').value
                },
                body: JSON.stringify({
                    requiredPermissions: ['COMPANY_REVIEW'],
                    type: 'COMPANY_REVIEW_PENDING',
                    title: 'æµ‹è¯•æƒé™é€šçŸ¥',
                    content: 'è¿™æ˜¯ä¸€ä¸ªåŸºäºæƒé™çš„æµ‹è¯•é€šçŸ¥ã€‚',
                    priority: 'HIGH',
                    category: 'REVIEW'
                })
            }).then(response => response.json())
            .then(data => {
                log('æƒé™é€šçŸ¥å‘é€ç»“æœ: ' + JSON.stringify(data));
            }).catch(error => {
                log('å‘é€æƒé™é€šçŸ¥å¤±è´¥: ' + error, 'error');
            });
        }

        function testSystemAlert() {
            fetch('/api/v1/admin/notifications/system-alert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + document.getElementById('token').value
                },
                body: JSON.stringify({
                    alertType: 'TEST_ALERT',
                    message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç³»ç»Ÿå‘Šè­¦æ¶ˆæ¯ã€‚',
                    level: 'warning'
                })
            }).then(response => response.json())
            .then(data => {
                log('ç³»ç»Ÿå‘Šè­¦å‘é€ç»“æœ: ' + JSON.stringify(data));
            }).catch(error => {
                log('å‘é€ç³»ç»Ÿå‘Šè­¦å¤±è´¥: ' + error, 'error');
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"è¿æ¥WebSocket"å¼€å§‹æµ‹è¯•');
            log('ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:3050');
            log('æ³¨æ„ï¼šCORSé—®é¢˜å·²ä¿®å¤ï¼Œç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸è¿æ¥äº†ï¼');
        };
    </script>
</body>
</html>