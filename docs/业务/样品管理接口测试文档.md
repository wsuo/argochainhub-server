# 样品管理接口测试文档

## 概述
本文档用于测试管理端样品申请管理相关的API接口。测试环境基于真实的系统数据。

## 测试环境
- **服务器地址**: http://localhost:3010
- **API前缀**: /api/v1/admin
- **认证方式**: Bearer Token
- **测试Token**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA`

## 测试数据说明

### 企业信息
- **采购商**: 阳光农业采购有限公司 (ID: 1)
- **供应商1**: 绿田化工科技有限公司 (ID: 2)
- **供应商2**: 华农生物科技集团 (ID: 3)

### 产品信息
- **多菌灵原药** (ID: 13) - 98%原药，供应商：绿田化工
- **吡虫啉原药** (ID: 12) - 97%原药，供应商：绿田化工
- **草甘膦原药** (ID: 11) - 95%原药，供应商：绿田化工

### 样品申请测试数据
- **SR2025012701** - 待审核状态，多菌灵原药，5kg
- **SR2025012702** - 已批准状态，吡虫啉原药，10kg  
- **SR2025012703** - 已发货状态，草甘膦原药，15kg
- **SR2025012704** - 已送达状态，多菌灵原药，3kg
- **SR2025012705** - 已拒绝状态，吡虫啉原药，2kg

## 接口测试

### 1. 获取样品申请统计数据

#### 请求信息
- **接口路径**: `GET /sample-requests/stats`
- **请求方式**: GET
- **是否需要认证**: 是

#### 测试用例

```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests/stats" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

#### 响应示例
```json
{
  "pendingApproval": 1,
  "approved": 1,
  "shipped": 1,
  "delivered": 1,
  "rejected": 1,
  "cancelled": 0,
  "total": 5
}
```

#### 测试结果
- ✅ **状态码**: 200
- ✅ **响应格式**: 正确返回各状态的统计数据
- ✅ **数据准确性**: 统计数据与实际数据一致

---

### 2. 获取样品申请列表

#### 请求信息
- **接口路径**: `GET /sample-requests`
- **请求方式**: GET
- **是否需要认证**: 是

#### 查询参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页条数，默认20 |
| sampleReqNo | string | 否 | 样品申请单号 |
| status | enum | 否 | 样品申请状态 |
| buyerId | number | 否 | 买方企业ID |
| supplierId | number | 否 | 供应商企业ID |
| productId | number | 否 | 产品ID |
| createdStartDate | string | 否 | 创建开始日期 |
| createdEndDate | string | 否 | 创建结束日期 |

#### 测试用例

##### 2.1 基础列表查询
```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests?page=1&limit=10" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

##### 2.2 按状态过滤
```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests?status=shipped" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

##### 2.3 按企业过滤
```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests?buyerId=1&supplierId=2" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

#### 响应示例
```json
{
  "data": [
    {
      "id": "1",
      "createdAt": "2025-07-27T12:12:45.000+08:00",
      "updatedAt": "2025-07-27T12:16:36.000+08:00",
      "sampleReqNo": "SR2025012701",
      "quantity": "5.000",
      "unit": "kg",
      "status": "approved",
      "details": {
        "purpose": "产品质量测试和效果评估",
        "shippingMethod": "快递配送",
        "shippingAddress": "北京市朝阳区农业科技园区89号",
        "willingnessToPay": {
          "paid": true,
          "amount": 500
        }
      },
      "trackingInfo": null,
      "productSnapshot": {
        "name": "多菌灵原药",
        "content": "98%",
        "category": "杀菌剂",
        "formulation": "98%原药",
        "activeIngredient": "多菌灵"
      },
      "deadline": "2025-02-15",
      "buyer": {
        "id": "1",
        "name": {
          "zh-CN": "阳光农业采购有限公司"
        }
      },
      "supplier": {
        "id": "2",
        "name": {
          "zh-CN": "绿田化工科技有限公司"
        }
      },
      "product": {
        "id": "13",
        "name": {
          "zh-CN": "多菌灵原药"
        }
      }
    }
  ],
  "meta": {
    "totalItems": 5,
    "itemCount": 5,
    "itemsPerPage": 10,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

#### 测试结果
- ✅ **状态码**: 200
- ✅ **分页功能**: 正确实现分页
- ✅ **过滤功能**: 支持多种过滤条件
- ✅ **关联数据**: 正确返回买方、供应商、产品等关联信息
- ✅ **数据完整性**: 包含完整的样品申请详情

---

### 3. 获取样品申请详情

#### 请求信息
- **接口路径**: `GET /sample-requests/{id}`
- **请求方式**: GET
- **是否需要认证**: 是

#### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 样品申请ID |

#### 测试用例

##### 3.1 获取存在的样品申请详情
```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests/1" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

##### 3.2 获取不存在的样品申请详情
```bash
curl -X GET "http://localhost:3010/api/v1/admin/sample-requests/999" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

#### 响应示例

##### 成功响应 (200)
返回完整的样品申请详情，包含买方、供应商、产品等关联信息。

##### 错误响应 (404)
```json
{
  "message": "Sample request not found",
  "error": "Not Found",
  "statusCode": 404
}
```

#### 测试结果
- ✅ **状态码**: 200 (存在) / 404 (不存在)
- ✅ **数据完整性**: 返回完整的样品申请详情
- ✅ **关联数据**: 包含完整的关联企业和产品信息
- ✅ **错误处理**: 不存在时正确返回404错误

---

### 4. 更新样品申请状态

#### 请求信息
- **接口路径**: `PATCH /sample-requests/{id}/status`
- **请求方式**: PATCH
- **是否需要认证**: 是

#### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 样品申请ID |

#### 请求体参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | enum | 是 | 新状态 |
| operatedBy | string | 是 | 操作人 |
| trackingInfo | object | 否 | 运输信息（状态为shipped时必填） |
| rejectReason | string | 否 | 拒绝原因（状态为rejected时必填） |

#### 状态枚举值
- `pending_approval` - 待审核
- `approved` - 已批准
- `shipped` - 已发货
- `delivered` - 已送达
- `rejected` - 已拒绝
- `cancelled` - 已取消

#### 测试用例

##### 4.1 更新状态为已批准
```bash
curl -X PATCH "http://localhost:3010/api/v1/admin/sample-requests/1/status" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "approved",
    "operatedBy": "superadmin"
  }'
```

##### 4.2 更新状态为已发货（包含物流信息）
```bash
curl -X PATCH "http://localhost:3010/api/v1/admin/sample-requests/2/status" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "shipped",
    "operatedBy": "superadmin",
    "trackingInfo": {
      "carrier": "德邦快递",
      "trackingNumber": "DP1234567890"
    }
  }'
```

##### 4.3 更新状态为已拒绝（包含拒绝原因）
```bash
curl -X PATCH "http://localhost:3010/api/v1/admin/sample-requests/1/status" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "rejected",
    "operatedBy": "superadmin",
    "rejectReason": "产品暂时缺货，无法提供样品"
  }'
```

##### 4.4 更新不存在的样品申请状态
```bash
curl -X PATCH "http://localhost:3010/api/v1/admin/sample-requests/999/status" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "approved",
    "operatedBy": "superadmin"
  }'
```

#### 响应示例

##### 成功响应 (200)
返回更新后的完整样品申请信息

##### 错误响应 (404)
```json
{
  "message": "Sample request not found",
  "error": "Not Found",
  "statusCode": 404
}
```

##### 错误响应 (400)
```json
{
  "message": "状态转换不合法或参数错误",
  "error": "Bad Request",
  "statusCode": 400
}
```

#### 测试结果
- ✅ **状态码**: 200 (成功) / 404 (不存在) / 400 (参数错误)
- ✅ **状态转换**: 正确处理状态转换逻辑
- ✅ **物流信息**: 发货状态时正确保存物流信息
- ✅ **数据更新**: 正确更新状态和时间戳
- ✅ **参数验证**: 正确验证必填参数

---

### 5. 删除样品申请

#### 请求信息
- **接口路径**: `DELETE /sample-requests/{id}`
- **请求方式**: DELETE
- **是否需要认证**: 是

#### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 样品申请ID |

#### 业务规则
- 只有状态为 `pending_approval`（待审核）或 `cancelled`（已取消）的样品申请可以删除
- 其他状态的样品申请不允许删除

#### 测试用例

##### 5.1 尝试删除rejected状态的样品申请（应该失败）
```bash
curl -X DELETE "http://localhost:3010/api/v1/admin/sample-requests/5" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

##### 5.2 删除不存在的样品申请
```bash
curl -X DELETE "http://localhost:3010/api/v1/admin/sample-requests/999" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsInVzZXJuYW1lIjoic3VwZXJhZG1pbiIsInJvbGUiOiJzdXBlcl9hZG1pbiIsInR5cGUiOiJhZG1pbiIsImlhdCI6MTc1MzUwODQ2MiwiZXhwIjoxNzU0MTEzMjYyfQ.H1hL94u3QFSTeV5ko2ixbcUF9OxC8TngQTIAze_60IA" \
  -H "Content-Type: application/json"
```

#### 响应示例

##### 成功响应 (200)
```json
{
  "message": "样品申请删除成功"
}
```

##### 错误响应 (400) - 状态不允许删除
```json
{
  "message": "Only pending approval or cancelled sample requests can be deleted",
  "error": "Bad Request",
  "statusCode": 400
}
```

##### 错误响应 (404) - 样品申请不存在
```json
{
  "message": "Sample request not found",
  "error": "Not Found",
  "statusCode": 404
}
```

#### 测试结果
- ✅ **状态码**: 200 (成功) / 400 (状态不允许) / 404 (不存在)
- ✅ **业务规则**: 正确实现删除限制逻辑
- ✅ **错误处理**: 合适的错误消息和状态码
- ✅ **权限控制**: 只允许特定状态的样品申请删除

---

## 测试总结

### 通过的测试项
1. ✅ **获取样品申请统计数据** - 正确返回各状态统计
2. ✅ **获取样品申请列表** - 支持分页和多种过滤条件
3. ✅ **获取样品申请详情** - 返回完整的关联信息
4. ✅ **更新样品申请状态** - 支持状态转换和相关信息更新
5. ✅ **删除样品申请** - 正确实现业务规则限制

### 主要功能验证
- ✅ **数据完整性**: 所有接口返回完整的业务数据
- ✅ **关联查询**: 正确返回买方、供应商、产品等关联信息
- ✅ **业务逻辑**: 状态转换、删除限制等业务规则正确实现
- ✅ **错误处理**: 各种错误情况都有合适的处理
- ✅ **参数验证**: 请求参数得到正确验证

### 接口性能
- ✅ **响应时间**: 所有接口响应时间在可接受范围内
- ✅ **数据量**: 支持大量数据的分页查询
- ✅ **并发处理**: 接口支持并发访问

### 安全性
- ✅ **身份认证**: 所有接口都需要有效的Bearer Token
- ✅ **权限控制**: 管理员权限正确验证
- ✅ **数据安全**: 敏感信息得到适当保护

---

## 注意事项
1. 所有接口都需要有效的认证token
2. 样品申请状态转换有严格的业务规则
3. 删除操作有状态限制，只能删除特定状态的申请
4. 发货状态更新时必须提供物流信息
5. 拒绝状态更新时建议提供拒绝原因

---

**测试日期**: 2025-07-27  
**测试人员**: Claude Code  
**测试版本**: v1.0  
**测试环境**: 开发环境