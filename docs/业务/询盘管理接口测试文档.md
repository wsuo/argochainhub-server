# 询盘管理接口测试文档

## 概述
询盘管理模块提供了完整的询价流程管理功能，包括创建询价单、报价、确认、拒绝和取消等操作。

## 基础信息

### 基础路径
- `/api/v1/inquiries`

### 认证方式
- Bearer Token (JWT)
- 需要在请求头中添加: `Authorization: Bearer {token}`

### 角色权限
- **买方(BUYER)**: 可以创建询价单、确认报价、取消询价单
- **供应商(SUPPLIER)**: 可以对询价单进行报价
- **通用**: 查看详情、拒绝操作（根据状态和角色有不同权限）

## 询价状态说明

| 状态 | 值 | 说明 |
|------|------|------|
| 待报价 | pending_quote | 买方创建询价单后的初始状态 |
| 已报价 | quoted | 供应商已提交报价 |
| 已确认 | confirmed | 买方确认供应商报价 |
| 已拒绝 | declined | 任一方拒绝（买方拒绝报价或供应商拒绝询价） |
| 已过期 | expired | 超过截止日期未处理 |
| 已取消 | cancelled | 买方主动取消询价单 |

## 接口详情

### 1. 创建询价单

**接口地址**: `POST /api/v1/inquiries`

**权限要求**: 
- 需要买方权限 (BUYER)
- 消耗询价配额

**请求示例**:
```json
{
  "supplierId": 1,
  "items": [
    {
      "productId": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装"
    },
    {
      "productId": 2,
      "quantity": 500,
      "unit": "kg"
    }
  ],
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "deadline": "2024-02-01"
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "pending_quote",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "deadline": "2024-02-01",
  "buyerId": 1,
  "supplierId": 2,
  "items": [
    {
      "id": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装",
      "productId": 1,
      "productSnapshot": {
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        },
        "pesticideName": {
          "zh": "吡唑醚菌酯",
          "en": "Pyraclostrobin"
        },
        "formulation": "SC",
        "activeIngredient1": {
          "name": {
            "zh": "吡唑醚菌酯",
            "en": "Pyraclostrobin"
          },
          "content": "25%"
        }
      }
    }
  ],
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z"
}
```

### 2. 获取我的询价单列表

**接口地址**: `GET /api/v1/inquiries`

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | string | 否 | 询价状态筛选 |
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认10 |

**请求示例**:
```
GET /api/v1/inquiries?status=pending_quote&page=1&limit=10
```

**响应示例**:
```json
{
  "items": [
    {
      "id": 1,
      "inquiryNo": "INQ202401010001",
      "status": "pending_quote",
      "deadline": "2024-02-01",
      "buyer": {
        "id": 1,
        "name": "买方公司A"
      },
      "supplier": {
        "id": 2,
        "name": "供应商公司B"
      },
      "itemCount": 2,
      "createdAt": "2024-01-01T10:00:00Z"
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10
}
```

### 3. 获取询价单详情

**接口地址**: `GET /api/v1/inquiries/:id`

**权限要求**: 只能查看与自己相关的询价单（作为买方或供应商）

**请求示例**:
```
GET /api/v1/inquiries/1
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "pending_quote",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "quoteDetails": null,
  "deadline": "2024-02-01",
  "buyer": {
    "id": 1,
    "name": "买方公司A",
    "contactPerson": "张三",
    "contactPhone": "13800138000"
  },
  "supplier": {
    "id": 2,
    "name": "供应商公司B",
    "contactPerson": "李四",
    "contactPhone": "13900139000"
  },
  "items": [
    {
      "id": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装",
      "product": {
        "id": 1,
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        }
      },
      "productSnapshot": {
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        },
        "pesticideName": {
          "zh": "吡唑醚菌酯",
          "en": "Pyraclostrobin"
        },
        "formulation": "SC",
        "activeIngredient1": {
          "name": {
            "zh": "吡唑醚菌酯",
            "en": "Pyraclostrobin"
          },
          "content": "25%"
        }
      }
    }
  ],
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z"
}
```

### 4. 对询价单进行报价

**接口地址**: `PATCH /api/v1/inquiries/:id/quote`

**权限要求**: 
- 需要供应商权限 (SUPPLIER)
- 只能对发给自己的询价单报价
- 询价单状态必须是 pending_quote

**请求示例**:
```json
{
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  }
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "quoted",
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  },
  "updatedAt": "2024-01-02T10:00:00Z"
}
```

### 5. 确认供应商报价

**接口地址**: `PATCH /api/v1/inquiries/:id/confirm`

**权限要求**: 
- 需要买方权限 (BUYER)
- 只能确认自己创建的询价单
- 询价单状态必须是 quoted

**请求示例**:
```
PATCH /api/v1/inquiries/1/confirm
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "confirmed",
  "message": "询价单已确认"
}
```

### 6. 拒绝询价或报价

**接口地址**: `PATCH /api/v1/inquiries/:id/decline`

**权限要求**: 
- 供应商可在 pending_quote 状态拒绝询价
- 买方可在 quoted 状态拒绝报价

**请求示例**:
```json
{
  "reason": "价格不符合预期"
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "declined",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告",
    "declineReason": "价格不符合预期",
    "declinedBy": "buyer"
  },
  "message": "询价单已拒绝"
}
```

### 7. 取消询价单

**接口地址**: `PATCH /api/v1/inquiries/:id/cancel`

**权限要求**: 
- 需要买方权限 (BUYER)
- 只能取消自己创建的询价单
- 询价单状态必须是 pending_quote

**请求示例**:
```
PATCH /api/v1/inquiries/1/cancel
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "cancelled",
  "message": "询价单已取消"
}
```

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权，需要登录 |
| 403 | 权限不足或操作不允许 |
| 404 | 询价单不存在 |
| 409 | 状态冲突，当前状态不允许该操作 |

## 测试注意事项

1. **配额限制**: 创建询价单会消耗询价配额，测试时需要确保账户有足够配额
2. **状态流转**: 注意测试各种状态之间的正确流转
3. **权限验证**: 测试不同角色对各接口的访问权限
4. **产品快照**: 创建询价单时会保存产品信息快照，即使产品信息更新也不会影响已创建的询价单
5. **时间限制**: 注意测试询价单截止日期的处理逻辑

## 常见测试场景

1. **完整流程测试**:
   - 买方创建询价单 → 供应商报价 → 买方确认

2. **拒绝流程测试**:
   - 买方创建询价单 → 供应商拒绝询价
   - 买方创建询价单 → 供应商报价 → 买方拒绝报价

3. **取消流程测试**:
   - 买方创建询价单 → 买方取消

4. **异常测试**:
   - 无权限访问
   - 错误的状态转换
   - 无效的产品ID
   - 配额不足

---

# 管理员询盘管理接口

## 概述
管理员询盘管理接口提供了后台管理系统对询价单的全面管理功能，包括查询、统计、详情查看、状态更新和删除等操作。

## 基础信息

### 基础路径
- `/api/v1/admin/inquiries`

### 认证方式
- Bearer Token (JWT)
- 需要管理员权限
- 需要在请求头中添加: `Authorization: Bearer {admin_token}`

## 管理员接口详情

### 1. 获取询价单列表

**接口地址**: `GET /api/v1/admin/inquiries`

**权限要求**: 
- 需要管理员权限

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认20 |
| inquiryNo | string | 否 | 询价单号筛选 |
| status | string | 否 | 询价状态筛选 |
| buyerId | number | 否 | 买方企业ID筛选 |
| supplierId | number | 否 | 供应商企业ID筛选 |
| createdStartDate | string | 否 | 创建开始日期 (YYYY-MM-DD) |
| createdEndDate | string | 否 | 创建结束日期 (YYYY-MM-DD) |
| keyword | string | 否 | 关键字搜索（支持询价单号、买方企业名、供应商企业名、产品名称模糊匹配） |
| buyerName | string | 否 | 买方企业名称（模糊匹配） |
| supplierName | string | 否 | 供应商企业名称（模糊匹配） |
| productName | string | 否 | 产品名称（模糊匹配） |

**请求示例**:
```
# 基础查询
GET /api/v1/admin/inquiries?page=1&limit=10&status=pending_quote&buyerId=1&createdStartDate=2024-01-01&createdEndDate=2024-01-31

# 关键字搜索（同时搜索询价单号、企业名、产品名）
GET /api/v1/admin/inquiries?keyword=草甘膦

# 买方企业名称模糊查询
GET /api/v1/admin/inquiries?buyerName=阳光农业

# 供应商企业名称模糊查询
GET /api/v1/admin/inquiries?supplierName=绿田化工

# 产品名称模糊查询
GET /api/v1/admin/inquiries?productName=草甘膦

# 组合查询
GET /api/v1/admin/inquiries?keyword=草甘膦&status=pending_quote&page=1&limit=10
```

**响应示例**:
```json
{
  "data": [
    {
      "id": 1,
      "inquiryNo": "INQ202401010001",
      "status": "pending_quote",
      "details": {
        "deliveryLocation": "上海港",
        "tradeTerms": "FOB",
        "paymentMethod": "T/T",
        "buyerRemarks": "需要提供质量检测报告和产品规格书"
      },
      "quoteDetails": null,
      "deadline": "2024-02-15",
      "buyer": {
        "id": 1,
        "name": {
          "zh-CN": "阳光农业采购有限公司",
          "en": "Sunshine Agricultural Procurement Co., Ltd."
        },
        "contactPerson": "李明",
        "contactPhone": "13800138000"
      },
      "supplier": {
        "id": 2,
        "name": {
          "zh-CN": "绿田化工科技有限公司",
          "en": "GreenField Chemical Technology Co., Ltd."
        },
        "contactPerson": "陈建国",
        "contactPhone": "0512-87654321"
      },
      "items": [
        {
          "id": 1,
          "quantity": 1000,
          "unit": "kg",
          "packagingReq": "25kg/袋",
          "productSnapshot": {
            "name": {
              "zh-CN": "草甘膦原药",
              "en": "Glyphosate Technical"
            },
            "pesticideName": {
              "zh-CN": "草甘膦",
              "en": "Glyphosate"
            },
            "formulation": "95%原药",
            "activeIngredient1": {
              "name": {
                "zh-CN": "草甘膦",
                "en": "Glyphosate"
              },
              "content": "95%"
            }
          }
        }
      ],
      "createdAt": "2024-01-01T10:00:00Z",
      "updatedAt": "2024-01-01T10:00:00Z"
    }
  ],
  "meta": {
    "totalItems": 25,
    "itemCount": 10,
    "itemsPerPage": 10,
    "totalPages": 3,
    "currentPage": 1
  }
}
```

### 2. 获取询价单统计数据

**接口地址**: `GET /api/v1/admin/inquiries/stats`

**权限要求**: 
- 需要管理员权限

**请求示例**:
```
GET /api/v1/admin/inquiries/stats
```

**响应示例**:
```json
{
  "pendingQuote": 5,
  "quoted": 8,
  "confirmed": 12,
  "declined": 3,
  "expired": 1,
  "cancelled": 2,
  "total": 31
}
```

### 3. 获取询价单详情

**接口地址**: `GET /api/v1/admin/inquiries/:id`

**权限要求**: 
- 需要管理员权限

**请求示例**:
```
GET /api/v1/admin/inquiries/1
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "pending_quote",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要提供质量检测报告和产品规格书"
  },
  "quoteDetails": null,
  "deadline": "2024-02-15",
  "buyer": {
    "id": 1,
    "name": {
      "zh-CN": "阳光农业采购有限公司",
      "en": "Sunshine Agricultural Procurement Co., Ltd."
    },
    "profile": {
      "address": "北京市朝阳区农业科技园区88号",
      "phone": "010-12345678",
      "website": "https://yangguang-agri.com"
    }
  },
  "supplier": {
    "id": 2,
    "name": {
      "zh-CN": "绿田化工科技有限公司",
      "en": "GreenField Chemical Technology Co., Ltd."
    },
    "profile": {
      "address": "江苏省苏州市工业园区创新路168号",
      "phone": "0512-87654321",
      "website": "https://lutian-chem.com"
    }
  },
  "items": [
    {
      "id": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋",
      "product": {
        "id": 1,
        "name": {
          "zh-CN": "草甘膦原药",
          "en": "Glyphosate Technical"
        },
        "status": "active"
      },
      "productSnapshot": {
        "name": {
          "zh-CN": "草甘膦原药",
          "en": "Glyphosate Technical"
        },
        "pesticideName": {
          "zh-CN": "草甘膦",
          "en": "Glyphosate"
        },
        "formulation": "95%原药",
        "activeIngredient1": {
          "name": {
            "zh-CN": "草甘膦",
            "en": "Glyphosate"
          },
          "content": "95%"
        }
      }
    }
  ],
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z"
}
```

### 4. 更新询价单状态

**接口地址**: `PATCH /api/v1/admin/inquiries/:id/status`

**权限要求**: 
- 需要管理员权限
- 可以强制更新任何状态

**请求示例1 - 更新为已报价状态**:
```json
{
  "status": "quoted",
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  },
  "operatedBy": "admin"
}
```

**请求示例2 - 更新为已拒绝状态**:
```json
{
  "status": "declined",
  "declineReason": "供应商无法满足交期要求",
  "operatedBy": "admin"
}
```

**请求示例3 - 更新为已确认状态**:
```json
{
  "status": "confirmed",
  "operatedBy": "admin"
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "quoted",
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  },
  "message": "询价单状态更新成功"
}
```

### 5. 删除询价单

**接口地址**: `DELETE /api/v1/admin/inquiries/:id`

**权限要求**: 
- 需要管理员权限
- 执行软删除操作

**请求示例**:
```
DELETE /api/v1/admin/inquiries/1
```

**响应示例**:
```json
{
  "message": "询价单删除成功"
}
```

## 管理员接口特点

### 权限差异
1. **数据范围**: 管理员可以查看所有询价单，不受企业限制
2. **状态控制**: 管理员可以强制更新询价单到任何状态
3. **删除权限**: 管理员可以删除询价单（软删除）
4. **统计功能**: 提供全局统计数据

### 高级筛选功能
1. **企业筛选**: 可按买方或供应商企业ID筛选
2. **时间范围**: 支持创建日期范围筛选
3. **状态筛选**: 支持按任意状态筛选
4. **关键词搜索**: 支持按询价单号搜索
5. **模糊查询功能**:
   - **keyword**: 万能搜索字段，同时搜索询价单号、买方企业名、供应商企业名、产品名称
   - **buyerName**: 专门搜索买方企业名称（支持中英文）
   - **supplierName**: 专门搜索供应商企业名称（支持中英文）
   - **productName**: 专门搜索产品名称和农药名称（支持中英文）

#### 模糊查询特性
- **多语言支持**: 自动搜索中文和英文字段
- **模糊匹配**: 使用LIKE操作，支持部分匹配
- **组合查询**: 可以与其他筛选条件组合使用
- **智能搜索**: keyword字段会同时搜索多个相关字段

#### 搜索优先级建议
1. **精确查找**: 使用 `inquiryNo` 按询价单号精确查找
2. **快速搜索**: 使用 `keyword` 进行跨字段模糊搜索
3. **定向搜索**: 使用 `buyerName`、`supplierName`、`productName` 进行针对性搜索
4. **组合搜索**: 结合状态、时间范围等进行复合查询

### 批量操作支持
- 支持分页查询大量数据
- 提供统计数据便于监控
- 支持多维度筛选组合

## 测试建议

### 管理员接口测试场景

1. **权限验证测试**:
   - 使用普通用户token访问管理员接口（应返回403）
   - 使用管理员token访问各个接口（应正常访问）

2. **数据范围测试**:
   - 验证管理员能查看所有企业的询价单
   - 验证筛选功能的正确性

3. **状态管理测试**:
   - 测试管理员强制更新状态功能
   - 验证状态更新记录和日志

4. **统计功能测试**:
   - 验证统计数据的准确性
   - 测试不同时间段的统计结果

5. **删除功能测试**:
   - 验证软删除功能
   - 确认删除后数据不在列表中显示

## 注意事项

1. **管理员token**: 确保使用正确的管理员JWT token
2. **数据权限**: 管理员接口返回完整的数据，包括敏感信息
3. **操作日志**: 所有管理员操作都会记录操作人信息
4. **软删除**: 删除操作为软删除，数据库中仍保留记录
5. **状态强制更新**: 管理员可以跳过业务流程强制更新状态，需谨慎使用