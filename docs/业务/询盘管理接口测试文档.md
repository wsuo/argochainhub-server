# 询盘管理接口测试文档

## 概述
询盘管理模块提供了完整的询价流程管理功能，包括创建询价单、报价、确认、拒绝和取消等操作。

## 基础信息

### 基础路径
- `/api/v1/inquiries`

### 认证方式
- Bearer Token (JWT)
- 需要在请求头中添加: `Authorization: Bearer {token}`

### 角色权限
- **买方(BUYER)**: 可以创建询价单、确认报价、取消询价单
- **供应商(SUPPLIER)**: 可以对询价单进行报价
- **通用**: 查看详情、拒绝操作（根据状态和角色有不同权限）

## 询价状态说明

| 状态 | 值 | 说明 |
|------|------|------|
| 待报价 | pending_quote | 买方创建询价单后的初始状态 |
| 已报价 | quoted | 供应商已提交报价 |
| 已确认 | confirmed | 买方确认供应商报价 |
| 已拒绝 | declined | 任一方拒绝（买方拒绝报价或供应商拒绝询价） |
| 已过期 | expired | 超过截止日期未处理 |
| 已取消 | cancelled | 买方主动取消询价单 |

## 接口详情

### 1. 创建询价单

**接口地址**: `POST /api/v1/inquiries`

**权限要求**: 
- 需要买方权限 (BUYER)
- 消耗询价配额

**请求示例**:
```json
{
  "supplierId": 1,
  "items": [
    {
      "productId": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装"
    },
    {
      "productId": 2,
      "quantity": 500,
      "unit": "kg"
    }
  ],
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "deadline": "2024-02-01"
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "pending_quote",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "deadline": "2024-02-01",
  "buyerId": 1,
  "supplierId": 2,
  "items": [
    {
      "id": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装",
      "productId": 1,
      "productSnapshot": {
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        },
        "pesticideName": {
          "zh": "吡唑醚菌酯",
          "en": "Pyraclostrobin"
        },
        "formulation": "SC",
        "activeIngredient1": {
          "name": {
            "zh": "吡唑醚菌酯",
            "en": "Pyraclostrobin"
          },
          "content": "25%"
        }
      }
    }
  ],
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z"
}
```

### 2. 获取我的询价单列表

**接口地址**: `GET /api/v1/inquiries`

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | string | 否 | 询价状态筛选 |
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认10 |

**请求示例**:
```
GET /api/v1/inquiries?status=pending_quote&page=1&limit=10
```

**响应示例**:
```json
{
  "items": [
    {
      "id": 1,
      "inquiryNo": "INQ202401010001",
      "status": "pending_quote",
      "deadline": "2024-02-01",
      "buyer": {
        "id": 1,
        "name": "买方公司A"
      },
      "supplier": {
        "id": 2,
        "name": "供应商公司B"
      },
      "itemCount": 2,
      "createdAt": "2024-01-01T10:00:00Z"
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10
}
```

### 3. 获取询价单详情

**接口地址**: `GET /api/v1/inquiries/:id`

**权限要求**: 只能查看与自己相关的询价单（作为买方或供应商）

**请求示例**:
```
GET /api/v1/inquiries/1
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "pending_quote",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告"
  },
  "quoteDetails": null,
  "deadline": "2024-02-01",
  "buyer": {
    "id": 1,
    "name": "买方公司A",
    "contactPerson": "张三",
    "contactPhone": "13800138000"
  },
  "supplier": {
    "id": 2,
    "name": "供应商公司B",
    "contactPerson": "李四",
    "contactPhone": "13900139000"
  },
  "items": [
    {
      "id": 1,
      "quantity": 1000,
      "unit": "kg",
      "packagingReq": "25kg/袋装",
      "product": {
        "id": 1,
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        }
      },
      "productSnapshot": {
        "name": {
          "zh": "25%吡唑醚菌酯",
          "en": "Pyraclostrobin 25%"
        },
        "pesticideName": {
          "zh": "吡唑醚菌酯",
          "en": "Pyraclostrobin"
        },
        "formulation": "SC",
        "activeIngredient1": {
          "name": {
            "zh": "吡唑醚菌酯",
            "en": "Pyraclostrobin"
          },
          "content": "25%"
        }
      }
    }
  ],
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z"
}
```

### 4. 对询价单进行报价

**接口地址**: `PATCH /api/v1/inquiries/:id/quote`

**权限要求**: 
- 需要供应商权限 (SUPPLIER)
- 只能对发给自己的询价单报价
- 询价单状态必须是 pending_quote

**请求示例**:
```json
{
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  }
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "quoted",
  "quoteDetails": {
    "totalPrice": 10000,
    "validUntil": "2024-02-15",
    "supplierRemarks": "价格含税，FOB上海港"
  },
  "updatedAt": "2024-01-02T10:00:00Z"
}
```

### 5. 确认供应商报价

**接口地址**: `PATCH /api/v1/inquiries/:id/confirm`

**权限要求**: 
- 需要买方权限 (BUYER)
- 只能确认自己创建的询价单
- 询价单状态必须是 quoted

**请求示例**:
```
PATCH /api/v1/inquiries/1/confirm
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "confirmed",
  "message": "询价单已确认"
}
```

### 6. 拒绝询价或报价

**接口地址**: `PATCH /api/v1/inquiries/:id/decline`

**权限要求**: 
- 供应商可在 pending_quote 状态拒绝询价
- 买方可在 quoted 状态拒绝报价

**请求示例**:
```json
{
  "reason": "价格不符合预期"
}
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "declined",
  "details": {
    "deliveryLocation": "上海港",
    "tradeTerms": "FOB",
    "paymentMethod": "T/T",
    "buyerRemarks": "需要质量检测报告",
    "declineReason": "价格不符合预期",
    "declinedBy": "buyer"
  },
  "message": "询价单已拒绝"
}
```

### 7. 取消询价单

**接口地址**: `PATCH /api/v1/inquiries/:id/cancel`

**权限要求**: 
- 需要买方权限 (BUYER)
- 只能取消自己创建的询价单
- 询价单状态必须是 pending_quote

**请求示例**:
```
PATCH /api/v1/inquiries/1/cancel
```

**响应示例**:
```json
{
  "id": 1,
  "inquiryNo": "INQ202401010001",
  "status": "cancelled",
  "message": "询价单已取消"
}
```

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权，需要登录 |
| 403 | 权限不足或操作不允许 |
| 404 | 询价单不存在 |
| 409 | 状态冲突，当前状态不允许该操作 |

## 测试注意事项

1. **配额限制**: 创建询价单会消耗询价配额，测试时需要确保账户有足够配额
2. **状态流转**: 注意测试各种状态之间的正确流转
3. **权限验证**: 测试不同角色对各接口的访问权限
4. **产品快照**: 创建询价单时会保存产品信息快照，即使产品信息更新也不会影响已创建的询价单
5. **时间限制**: 注意测试询价单截止日期的处理逻辑

## 常见测试场景

1. **完整流程测试**:
   - 买方创建询价单 → 供应商报价 → 买方确认

2. **拒绝流程测试**:
   - 买方创建询价单 → 供应商拒绝询价
   - 买方创建询价单 → 供应商报价 → 买方拒绝报价

3. **取消流程测试**:
   - 买方创建询价单 → 买方取消

4. **异常测试**:
   - 无权限访问
   - 错误的状态转换
   - 无效的产品ID
   - 配额不足